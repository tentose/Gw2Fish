@page "/settings"
@inject ISettingsService SettingsService

<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="mud-width-full py-8 px-8">
            <MudTextField T="string" Label="API Key" Class="mb-3" Validation="ValidateGw2ApiKey"/>
            <MudText>Don't have an API key? Get one here: <MudLink Href="https://account.arena.net/applications">https://account.arena.net/applications</MudLink></MudText>
            <MudText>For more details, see the wiki: <MudLink Href="https://wiki.guildwars2.com/wiki/API:API_key">https://wiki.guildwars2.com/wiki/API:API_key</MudLink></MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12">
        <MudPaper Class="mud-width-full py-8 px-8">
            <MudSwitch Color="Color.Primary" Class="ma-4" T="bool" Label="Toggle Light/Dark Mode" CheckedChanged="DarkModeChecked" Checked="SettingsService.IsDarkMode"/>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SettingsService.InitializeSettings();
            //_isDarkMode = SettingsService.IsDarkMode;
            StateHasChanged();
        }
    }

    private void DarkModeChecked(bool isChecked)
    {
        SettingsService.SetDarkMode(isChecked);
    }

    private bool ValidateGw2ApiKey(string key)
    {
        var regex = new System.Text.RegularExpressions.Regex(@"^[0-9A-Z]{8}-[0-9A-Z]{4}-[0-9A-Z]{4}-[0-9A-Z]{4}-[0-9A-Z]{20}-[0-9A-Z]{4}-[0-9A-Z]{4}-[0-9A-Z]{4}-[0-9A-Z]{12}$");
        bool isMatch = regex.IsMatch(key);
        if (isMatch || key == "")
        {
            SetGw2ApiKey(key);
        }
        return isMatch;
    }

    private void SetGw2ApiKey(string key)
    {
        SettingsService.SetGw2ApiKey(key);
    }
}
